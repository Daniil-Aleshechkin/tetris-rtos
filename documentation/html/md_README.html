<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Tetris-RTOS: Final Project</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Tetris-RTOS
   </div>
   <div id="projectbrief">A simple version of modern Tetris powered by FreeRTOS</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Final Project </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="autotoc_md1"></a>
Running the project</h1>
<p>After the binary has been flashed with:</p>
<div class="fragment"><div class="line">final&gt; st-flash --reset write ./bin/firmware.bin 0x08000000</div>
</div><!-- fragment --><p>You can connect with the project using a serial client. Using pyserial:</p>
<div class="fragment"><div class="line">python -m serial.tools.miniterm COM4 1500000 -f direct</div>
</div><!-- fragment --><p>You can also use PuTTy: <img src="./images/putty.png" alt="Putty" class="inline"/></p>
<p>Note that the baud rate is now <b>1,500,000</b></p>
<h1><a class="anchor" id="autotoc_md2"></a>
Using the custom serial client</h1>
<p>As noted in my video demo, to properly use the extra DAS features of the project, you need run the custom serial client that uses tkinter and pyserial. This is only required for sending keyup events, so the vaste majority of the features can still be tested without it (it's as if the user is always holding down a key).</p>
<h2><a class="anchor" id="autotoc_md3"></a>
Sharing the serial port</h2>
<p>Before we install this client we need to get around a problem. Unfortunatly, windows does not allow different programs to share a serial port...</p>
<p>The only way around this issue I've found is to set up the client in WSL which allows this. I tried to use a serial port splitter (<a href="https://www.serial-port-splitter.com/serial-port-splitter-download.html">https://www.serial-port-splitter.com/serial-port-splitter-download.html</a>), and while I got it working on the milestone 1 version of the project, it screws up the VT100 codes I used to get color making it unusable for this version.</p>
<h3><a class="anchor" id="autotoc_md4"></a>
Setting up the terminal client in WSL</h3>
<p>Before you install WSL, you need to enable the feature set. Run the following as admin</p>
<div class="fragment"><div class="line">Enable-WindowsOptionalFeature -Online -FeatureName Microsoft-Windows-Subsystem-Linux</div>
</div><!-- fragment --><p>Firstly you need to install a wsl distro. (I used ubuntu). You can install it with this command</p>
<div class="fragment"><div class="line">wsl --install -d Ubuntu</div>
</div><!-- fragment --><p>This will ask you for a username and password to set up your linux user.</p>
<p>I recommend to connect to it, to use the WSL extention in VSCode.</p>
<p>Just open VSCode search WSL, and it's the one by microsoft. (Extention ID: ms-vscode-remote.remote-wsl)</p>
<p>Using that extention</p>
<ol type="1">
<li>Type: Windows-Key-Shift-P to open the vscode command pallete</li>
<li>Search "WSL: Connect to WSL using Distro..."</li>
<li>Select Ubuntu</li>
</ol>
<p>This will now connect you to your WSL instance.</p>
<h4><a class="anchor" id="autotoc_md5"></a>
Setting up the serial port</h4>
<p>Another windows pain. Microsoft has removed the ability for WSL to talk to the windows COM ports in WSL 2.0.</p>
<p>To get around this we will install a program called usbipd. This essentially hijacks the serial port and hosts a proxy socket that the WSL distro can connect to.</p>
<p>On your windows machine, install usbipd: <a href="https://github.com/dorssel/usbipd-win">https://github.com/dorssel/usbipd-win</a></p>
<p>Open in powershell, and list the currently available serial ports</p>
<div class="fragment"><div class="line">usbipd list</div>
</div><!-- fragment --><p>Note the ST-Link Bus ID (Mine was 1-1, but your machine could be different). Attach it to WSL with this command</p>
<div class="fragment"><div class="line">usbipd wsl attach --busid 1-1 --distribution Ubuntu</div>
</div><!-- fragment --><p>You'll hear the device disconnect after that. Now in WSL, you should note what device it got installed to. Run the following to figure out the device file.</p>
<div class="fragment"><div class="line">ls /dev/tty*</div>
</div><!-- fragment --><p>The one that starts with /dev/ttyACM, should be the linked device. (Mine was /dev/ttyACM0). This will be used in place of the COM port to connect to it.</p>
<p>With all of that set up, you can now simply clone my repo, to get the python code to run the terminal</p>
<div class="fragment"><div class="line">git clone https://github.com/Daniil-Aleshechkin/tetris-rtos.git</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md6"></a>
Installing dependancies</h2>
<p>Ensure you have python installed. Any version of python 3 should be fine (This was developed on 3.8, due to arm-none-eabi-gdb requiring it).</p>
<p><b>Note:</b> On WSL Ubuntu python is pre-installed as python3, there's a convient package to add a symlink to python3</p>
<div class="fragment"><div class="line">sudo apt-get install python-is-python3</div>
</div><!-- fragment --><p>The only dependancies are tkinter and pyserial. Tkinter should be packaged by default, and you can test if you have it installed with.</p>
<div class="fragment"><div class="line">python -m tkinter</div>
</div><!-- fragment --><p>Pyserial can be installed with</p>
<div class="fragment"><div class="line">pip install pyserial</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md7"></a>
Using a virtual environment</h2>
<p>Alternatevly you can also use the built in virtual environment activating it by running the powershell script.</p>
<div class="fragment"><div class="line">final&gt; ./tetris-rtos/bin/Activate.ps1</div>
</div><!-- fragment --><p><b>Important!</b> Make sure you have your powershell execution policy set to unrestricted. I'm not sure if this is a requirement with python virtual environment nowadays, but it's a common gotcha when running powershell scripts.</p>
<p>You can set it using the command:</p>
<div class="fragment"><div class="line">Set-ExecutionPolicy Unrestricted</div>
</div><!-- fragment --><p>Or bash script if in WSL</p>
<div class="fragment"><div class="line">final&gt; source .\tetris-rtos\bin\activate</div>
</div><!-- fragment --><p>Once python is installed with all the dependancies</p>
<div class="fragment"><div class="line">final&gt; python ./terminal/terminal.py **SERIAL PORT HERE**</div>
</div><!-- fragment --><p><b>Note:</b> When running this on windows, you may see an error about "xset not being found". xset is a tool I used in linux to disable the auto repeat of keys when you hold it by the system. Windows doesn't have this installed so it's likely it will throw something. The program should still run fine though.</p>
<p>This will open a tkinter window. Click the window to focus it, so it will start capturing keyboard events.</p>
<p><b>Note:</b> if on WSL, pyserial is the only method I know of reading the serial port. Quitting pyserial is a little unintuative It uses the keys "CTRL-]"</p>
<div class="fragment"><div class="line">python -m serial.tools.miniterm /dev/ttyAMC0 1500000 -f direct</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md8"></a>
Using the project</h1>
<h2><a class="anchor" id="autotoc_md9"></a>
Controls</h2>
<p>The controls hardcoded to the following when directly connected to USART <b>Note:</b> Make sure num-lock is on. If it's off, I've noticed the keys do not get picked up.</p>
<ul>
<li>D: Hard drop</li>
<li>S: Soft drop</li>
<li>W: 270 rotate</li>
<li>Q: 180 rotate</li>
<li>R: Reset Board</li>
<li>Tab: Hold piece</li>
<li>Numpad 4: Move left</li>
<li>Numpad 6: Move right</li>
<li>Numpad 8: Rotate 90</li>
<li>Numpad 5: Softdrop</li>
<li>P: Exit to CLI</li>
</ul>
<p>The controls when connected using the custom serial client are the following:</p>
<ul>
<li>D: Hard drop</li>
<li>S: Soft drop</li>
<li>W: 270 rotate</li>
<li>Q: 180 rotate</li>
<li>R: Reset Board</li>
<li>Tab: Hold piece</li>
<li>Arrow Right: Move left</li>
<li>Arrow Left: Move right</li>
<li>Arrow Up: Rotate 90</li>
<li>Arrow Down: Softdrop</li>
<li>P: Exit to CLI</li>
</ul>
<h1><a class="anchor" id="autotoc_md10"></a>
CLI Commands</h1>
<p>The commands should be case insensitive</p>
<p>Help: Displays a help screen with some information about what commands are available DAS N: Set the DAS delay value to whatever N is. This is amount of ticks, in the DAS task, because I couldn't get the timer to work due to the same linking issue with the interupts. So, there is unfortunatly no real world equivalent to it. ARR N: Set the ARR delay value to whatever N is. Same as DAS delay: No real world equivalent. dasenable: Enable the DAS feature dasdisable: disable the DAS feature quit: Return back to the game</p>
<h1><a class="anchor" id="autotoc_md11"></a>
Known Bugs</h1>
<p>Tetris will randomely crash on occasion. Only solution is to reset the board. I thought putting the tetris state behind a mutex would fix this, but it didn't (It's not a memory issue as I have it spamming Us if it is out of memory).</p>
<p>The softdrop will not register that you released the key on occasion. The only solution is just to press the softdrop key again.</p>
<p>Sometimes when clearing the board, some blocks get copied instead of cleared. This is a bug from my previous project that was inherited because I didn't modify the Tetris Domain code at all. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1
</small></address>
</body>
</html>
